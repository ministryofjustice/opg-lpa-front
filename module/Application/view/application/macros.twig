{# Form Validation - Error Summary #}
{% macro formErrorSummary(error, form, message) %}

    {% if (error is not empty or form.getMessages|length > 0) %}
    <div class="error-summary" role="group" aria-labelledby="error-heading" tabindex="-1">
        <h1 class="heading-medium error-summary-heading" id="error-heading">{{ message }}</h1>

        {# Show this only if it's a form error #}
        {% if form.getMessages|length > 0 %}
            <p>You need to do the following:</p>
        {% endif %}

        <ul class="error-summary-list text">
            {# Form errors #}
            {{ formLinkedErrorListV2(form) ? '' }}

            {# API errors #}
            {% if error is not empty %}
                <li><p>
                    {% if error == 'user-not-found' %}
                        We could not find an account for this email address.
                    {% elseif error == 'address-already-registered' %}
                        This email address has already been registered. Please <a href="{{ url('login') }}">sign in</a> or <a href="{{ url('forgot-password') }}">reset your password</a>.
                    {% elseif error == 'user-already-has-email' %}
                        You're already using that email address for this account – please enter another email address.
                    {% elseif error == 'email-already-exists' %}
                        Another LPA account is already using that email address – please enter a different email address.
                    {% else %}
                        {{ error }}
                    {% endif %}
                </p></li>
            {% endif %}
        </ul>
    </div>
    {% endif %}

{% endmacro %}

{# Text input #}
{% macro formGroup(element) %}

<div class="form-group {{ element.getMessages|length >0 ? 'error'}}">
    <label class="form-label" for="{{ element.getAttribute('id') }}">
        {{ element.getOption('label') }}
        {{ formElementErrorsV2(element) }}
    </label>
    {{ formElement(element) }}
</div>

{% endmacro %}

{# Checkbox #}
{% macro formGroupCheckbox(element) %}

<div class="option group">
    <label class="form-label" for="{{ element.getAttribute('id') }}">
        {{ element.getOption('label')|raw }}
    </label>
    {{ formElement(element) }}
</div>

{% endmacro %}

{# Add reuse details options #}
{% macro renderReuseDetailsOptions(reuseDetailsForm) %}
    {% if (reuseDetailsForm) %}
        {# form fields config #}
        {{ reuseDetailsForm.setAttributes({
            'class':'form'
        }) ? '' }}

        {# Check how many value options are in the reuse details element in the form - if there is only one we will display as a hyperlink #}
        {% set reuseDetailsInput = reuseDetailsForm.get('reuse-details') %}
        {% set reuseDetailsOptions = reuseDetailsInput.getValueOptions() %}

        {% if (reuseDetailsOptions|length == 1) %}
            {% set currentUrl = serverUrl(true) %}

            {% if ('reuse-details' not in currentUrl) %}
                {% set queryJoiner = '?' %}

                {% if (queryJoiner in currentUrl) %}
                    {% set queryJoiner = '&' %}
                {% endif %}

                {% set linkText = 'Use my details' %}

                {% if (reuseDetailsForm.hasTrustDataOnly()) %}
                    {% set trustDetails = reuseDetailsOptions|first %}
                    {% set linkText = 'Use details of the ' ~ trustDetails.label %}
                {% endif %}

                <div class="use-details-link-panel">
                    {# TODO - data-target added due to problems retriving the href attribute in jQuery #}
                    <a class="js-reusable" href="{{ currentUrl }}{{ queryJoiner }}reuse-details=0"
                        data-target="{{ currentUrl }}{{ queryJoiner }}reuse-details=0">{{ linkText }}</a>
                </div>
            {% endif %}
        {% elseif (reuseDetailsOptions|length > 1) %}
            {# Put the form in a step panel #}
            <div class="js-step">
                {# Set form fields variables #}
                {% set reuseDetailsSubmit = reuseDetailsForm.get('submit') %}

                {{ reuseDetailsInput.setAttributes({
                    'id':    'reuse-details',
                    'class': 'js-reusable',
                }) ? '' }}

                {# form fields config #}
                {{ reuseDetailsSubmit.setAttributes({
                    'value': 'Use this person\'s details',
                    'class': 'button flush--left js-hidden'
                }) ? '' }}

                {# begin form #}
                {{ reuseDetailsForm.prepare() ? '' }}

                {{ form().openTag(reuseDetailsForm)|raw }}

                    <fieldset class="reuse-details-container">
                        <h2 class="reuse-details-heading heading-medium flush--top">Which person's details would you like to reuse?</h2>

                        <div class="form-group">
                            {{ formElement(reuseDetailsInput) }}
                        </div>
                        <div class="form-group">
                            {{ formElement(reuseDetailsSubmit) }}
                            <input type="button" class="button button-secondary reuse-details-cancel-button js-cancel" value="Cancel" />
                        </div>
                    </fieldset>

                {{ form().closeTag|raw }}
            </div>
        {% endif %}
    {% endif %}
{% endmacro %}

{% macro addSwitchAttorneyTypeLink(switchAttorneyTypeRoute, lpa, trustLink) %}
    {% if (switchAttorneyTypeRoute) %}
        <div class="use-details-link-panel">
            <a class="js-form-popup" href="{{ url(switchAttorneyTypeRoute, {'lpa-id': lpa.id}) }}">Using {{ trustLink ? 'a trust corporation' : 'an individual' }}?</a>
        </div>
    {% endif %}
{% endmacro %}